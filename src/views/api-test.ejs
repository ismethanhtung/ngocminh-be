<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= title %></title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/milligram/1.4.1/milligram.min.css"
    />
    <style>
      body {
        max-width: 1000px;
        margin: 24px auto;
      }
      code,
      pre {
        background: #f4f4f4;
        padding: 8px;
        display: block;
        white-space: pre-wrap;
      }
      .row {
        display: flex;
        gap: 16px;
      }
      .row > div {
        flex: 1;
      }
      .card {
        border: 1px solid #eee;
        padding: 16px;
        border-radius: 8px;
      }
    </style>
  </head>
  <body>
    <h2>API Test</h2>
    <p>Base: <code><%= apiBase %></code></p>

    <div class="row">
      <div class="card">
        <h4>1) ViewHAResult theo FileNum 25006829</h4>
        <form id="form-ha-results">
          <label
            >FileNum
            <input type="text" id="fileNum" placeholder="VD: 25003245" />
          </label>
          <button type="submit">Gọi API</button>
        </form>
        <pre id="out-ha-results"></pre>
      </div>

      <div class="card">
        <h4>2) Clinical Items theo ID lấy từ ViewHAResult</h4>
        <form id="form-clinical">
          <label
            >ResultId
            <input type="number" id="clinicalResultId" />
          </label>
          <button type="submit">Gọi API</button>
        </form>
        <pre id="out-clinical"></pre>
      </div>

      <div class="card">
        <h4>11) Upload tài liệu HA và cập nhật FileName theo ItemNum</h4>
        <form id="form-upload-ha-docs">
          <label>Chọn 1 hoặc nhiều file (vd: 250015134.pdf)</label>
          <input type="file" id="haDocs" name="files" multiple />
          <button type="submit">Upload</button>
        </form>
        <pre id="out-upload-ha-docs"></pre>
      </div>

      <div class="card">
        <h4>12) Tải file đã upload theo filename</h4>
        <form id="form-download-ha-doc">
          <label>Filename</label>
          <input type="text" id="downloadFileName" placeholder="vd: 250015134.pdf" />
          <button type="submit">Tải xuống</button>
        </form>
        <pre id="out-download-ha-doc"></pre>
      </div>

      <div class="card">
        <h4>13) ViewHAResultDetail theo ItemNum</h4>
        <form id="form-result-detail-by-item">
          <label>ItemNum</label>
          <input type="text" id="itemNumForResultDetail" placeholder="vd: 250015134" />
          <button type="submit">Gọi API</button>
        </form>
        <pre id="out-result-detail-by-item"></pre>
      </div>
    </div>

    <div class="row">
      <div class="card">
        <h4>14) Lấy thông tin file từ S3</h4>
        <form id="form-s3-file-info">
          <label>Filename</label>
          <input type="text" id="s3FileName" placeholder="vd: example.pdf" />
          <button type="submit">Lấy thông tin</button>
        </form>
        <pre id="out-s3-file-info"></pre>
      </div>

      <div class="card">
        <h4>15) Tạo signed URL để tải file từ S3</h4>
        <form id="form-s3-download-url">
          <label>Filename</label>
          <input type="text" id="s3DownloadFileName" placeholder="vd: example.pdf" />
          <label>Thời gian hết hạn (giây)</label>
          <input type="number" id="s3ExpiresIn" placeholder="3600" value="3600" />
          <button type="submit">Tạo URL</button>
        </form>
        <pre id="out-s3-download-url"></pre>
      </div>
    </div>

    <div class="row">
      <div class="card">
        <h4>16) Tải file trực tiếp từ S3</h4>
        <form id="form-s3-download">
          <label>Filename</label>
          <input type="text" id="s3DirectDownloadFileName" placeholder="vd: example.pdf" />
          <button type="submit">Tải file</button>
        </form>
        <pre id="out-s3-download"></pre>
      </div>

      <div class="card">
        <h4>17) Redirect đến file trong S3</h4>
        <form id="form-s3-redirect">
          <label>Filename</label>
          <input type="text" id="s3RedirectFileName" placeholder="vd: example.pdf" />
          <label>Thời gian hết hạn (giây)</label>
          <input type="number" id="s3RedirectExpiresIn" placeholder="3600" value="3600" />
          <button type="submit">Redirect</button>
        </form>
        <pre id="out-s3-redirect"></pre>
      </div>
    </div>

    <div class="row">
      <div class="card">
        <h4>18) Lấy data viewImageFileName theo ItemNum</h4>
        <form id="form-view-image-file-name">
          <label>ItemNum</label>
          <input type="text" id="viewImageFileNameItemNum" placeholder="vd: 250015134" />
          <button type="submit">Lấy data</button>
        </form>
        <pre id="out-view-image-file-name"></pre>
      </div>

      <div class="card">
        <h4>19) Lấy tất cả data viewImageFileName</h4>
        <form id="form-all-view-image-file-name">
          <button type="submit">Lấy tất cả data</button>
        </form>
        <pre id="out-all-view-image-file-name"></pre>
      </div>
    </div>

    <div class="row">
      <div class="card">
        <h4>20) Lấy cấu trúc viewImageFileName</h4>
        <form id="form-view-image-file-name-structure">
          <button type="submit">Lấy cấu trúc</button>
        </form>
        <pre id="out-view-image-file-name-structure"></pre>
      </div>
    </div>

    <div class="row">
      <div class="card">
        <h4>3) Xét nghiệm (Pathology) theo ResultId</h4>
        <form id="form-pathology">
          <label
            >ResultId
            <input type="number" id="pathologyResultId" />
          </label>
          <button type="submit">Gọi API</button>
        </form>
        <pre id="out-pathology"></pre>
      </div>

      <div class="card">
        <h4>4) Chuỗi Chẩn đoán hình ảnh theo ItemNum</h4>
        <form id="form-imaging">
          <label
            >ItemNum
            <input type="number" id="itemNum" />
          </label>
          <button type="submit">Gọi API</button>
        </form>
        <pre id="out-imaging"></pre>
      </div>
    </div>

    <div class="row">
      <div class="card">
        <h4>5) Tiền sử sản phụ khoa theo PatientId</h4>
        <form id="form-obstetric-history">
          <label>PatientId</label>
          <input type="text" id="patientId" />
          <button type="submit">Gọi API</button>
        </form>
        <pre id="out-obstetric-history"></pre>
      </div>
      <div class="card">
        <h4>6) Khám tổng quát theo PatientId</h4>
        <form id="form-general-exam">
          <label>PatientId</label>
          <input type="text" id="patientIdGeneralExam" />
          <button type="submit">Gọi API</button>
        </form>
        <pre id="out-general-exam"></pre>
      </div>
    </div>

    <div class="row">
      <div class="card">
        <h4>7) ViewHAResult theo ItemNum</h4>
        <form id="form-ha-by-item">
          <label>ItemNum</label>
          <input type="text" id="itemNumQuery" />
          <button type="submit">Gọi API</button>
        </form>
        <pre id="out-ha-by-item"></pre>
      </div>

      <div class="card">
        <h4>8) Tất cả data trong ViewHAData</h4>
        <form id="form-all-ha-data">
          <button type="submit">Gọi API</button>
        </form>
        <pre id="out-all-ha-data"></pre>
      </div>
    </div>

    <div class="row">
      <div class="card">
        <h4>9) ViewHAResultDetail theo DataId</h4>
        <form id="form-result-detail">
          <label>DataId</label>
          <input type="number" id="dataId" />
          <button type="submit">Gọi API</button>
        </form>
        <pre id="out-result-detail"></pre>
      </div>

      <div class="card">
        <h4>10) Cập nhật HA_ResultDetail theo Id</h4>
        <form id="form-update-result-detail">
          <label>Id</label>
          <input type="number" id="updateId" required />

          <label>HealthType</label>
          <input type="text" id="healthType" placeholder="Loại sức khỏe" />

          <label>Conclusion</label>
          <textarea id="conclusion" placeholder="Kết luận" rows="3"></textarea>

          <label>Suggestion</label>
          <textarea id="suggestion" placeholder="Đề xuất" rows="3"></textarea>

          <label>ConclusionDate</label>
          <input type="date" id="conclusionDate" />

          <label>FileName</label>
          <input type="text" id="fileName" placeholder="Tên file" />

          <label>ConclusionDoctor</label>
          <input type="text" id="conclusionDoctor" placeholder="Bác sĩ kết luận" />

          <button type="submit">Cập nhật</button>
        </form>
        <pre id="out-update-result-detail"></pre>
      </div>
    </div>

    <script>
      const apiBase = '<%= apiBase %>';

      function show(outId, data) {
        document.getElementById(outId).textContent = JSON.stringify(data, null, 2);
      }

      document.getElementById('form-ha-results').addEventListener('submit', async e => {
        e.preventDefault();
        const fileNum = document.getElementById('fileNum').value.trim();
        const res = await fetch(`${apiBase}/ha/results?fileNum=${encodeURIComponent(fileNum)}`);
        show('out-ha-results', await res.json());
      });

      document.getElementById('form-clinical').addEventListener('submit', async e => {
        e.preventDefault();
        const id = document.getElementById('clinicalResultId').value;
        const res = await fetch(`${apiBase}/ha/clinical-items/${id}`);
        show('out-clinical', await res.json());
      });

      document.getElementById('form-pathology').addEventListener('submit', async e => {
        e.preventDefault();
        const id = document.getElementById('pathologyResultId').value;
        const res = await fetch(`${apiBase}/ha/pathology/${id}`);
        show('out-pathology', await res.json());
      });

      document.getElementById('form-imaging').addEventListener('submit', async e => {
        e.preventDefault();
        const itemNum = document.getElementById('itemNum').value;
        const res = await fetch(`${apiBase}/ha/imaging?itemNum=${itemNum}`);
        show('out-imaging', await res.json());
      });

      document.getElementById('form-obstetric-history').addEventListener('submit', async e => {
        e.preventDefault();
        const patientId = document.getElementById('patientId').value;
        const res = await fetch(
          `${apiBase}/ha/obstetric-history?patientId=${encodeURIComponent(patientId)}`
        );
        show('out-obstetric-history', await res.json());
      });

      document.getElementById('form-general-exam').addEventListener('submit', async e => {
        e.preventDefault();
        const patientId = document.getElementById('patientIdGeneralExam').value;
        const res = await fetch(
          `${apiBase}/ha/general-exam?patientId=${encodeURIComponent(patientId)}`
        );
        show('out-general-exam', await res.json());
      });

      document.getElementById('form-ha-by-item').addEventListener('submit', async e => {
        e.preventDefault();
        const itemNum = document.getElementById('itemNumQuery').value;
        const res = await fetch(
          `${apiBase}/ha/results-by-item?itemNum=${encodeURIComponent(itemNum)}`
        );
        show('out-ha-by-item', await res.json());
      });

      document.getElementById('form-all-ha-data').addEventListener('submit', async e => {
        e.preventDefault();
        const res = await fetch(`${apiBase}/ha/all-data`);
        show('out-all-ha-data', await res.json());
      });

      document.getElementById('form-result-detail').addEventListener('submit', async e => {
        e.preventDefault();
        const dataId = document.getElementById('dataId').value;
        const res = await fetch(`${apiBase}/ha/result-detail/${dataId}`);
        show('out-result-detail', await res.json());
      });

      document.getElementById('form-update-result-detail').addEventListener('submit', async e => {
        e.preventDefault();
        const id = document.getElementById('updateId').value;

        const updateData = {};
        const healthType = document.getElementById('healthType').value.trim();
        const conclusion = document.getElementById('conclusion').value.trim();
        const suggestion = document.getElementById('suggestion').value.trim();
        const conclusionDate = document.getElementById('conclusionDate').value;
        const fileName = document.getElementById('fileName').value.trim();
        const conclusionDoctor = document.getElementById('conclusionDoctor').value.trim();

        // Gửi tất cả các trường, kể cả chuỗi rỗng để có thể xóa
        updateData.HealthType = healthType;
        updateData.Conclusion = conclusion;
        updateData.Suggestion = suggestion;
        updateData.ConclusionDate = conclusionDate;
        updateData.FileName = fileName;
        updateData.ConclusionDoctor = conclusionDoctor;

        const res = await fetch(`${apiBase}/ha/result-detail/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(updateData),
        });
        show('out-update-result-detail', await res.json());
      });

      // 11) Upload HA docs và cập nhật FileName theo ItemNum
      document.getElementById('form-upload-ha-docs').addEventListener('submit', async e => {
        e.preventDefault();
        const input = document.getElementById('haDocs');
        const formData = new FormData();
        for (const file of input.files) {
          formData.append('files', file);
        }
        const res = await fetch(`${apiBase}/ha/upload-ha-docs`, {
          method: 'POST',
          body: formData,
        });
        show('out-upload-ha-docs', await res.json());
      });

      // 12) Download HA doc theo filename
      document.getElementById('form-download-ha-doc').addEventListener('submit', async e => {
        e.preventDefault();
        const name = document.getElementById('downloadFileName').value.trim();
        if (!name) {
          show('out-download-ha-doc', { success: false, message: 'Vui lòng nhập filename' });
          return;
        }
        // mở file ở tab mới
        window.open(`${apiBase}/ha/ha-docs/${encodeURIComponent(name)}`, '_blank');
        show('out-download-ha-doc', { success: true, message: 'Đang tải file ở tab mới' });
      });

      // 13) ViewHAResultDetail theo ItemNum
      document.getElementById('form-result-detail-by-item').addEventListener('submit', async e => {
        e.preventDefault();
        const itemNum = document.getElementById('itemNumForResultDetail').value.trim();
        if (!itemNum) {
          show('out-result-detail-by-item', { success: false, message: 'Vui lòng nhập ItemNum' });
          return;
        }
        const res = await fetch(
          `${apiBase}/ha/result-detail-by-item?itemNum=${encodeURIComponent(itemNum)}`
        );
        show('out-result-detail-by-item', await res.json());
      });

      // 14) Lấy thông tin file từ S3
      document.getElementById('form-s3-file-info').addEventListener('submit', async e => {
        e.preventDefault();
        const filename = document.getElementById('s3FileName').value.trim();
        if (!filename) {
          show('out-s3-file-info', { success: false, message: 'Vui lòng nhập filename' });
          return;
        }
        const res = await fetch(`${apiBase}/s3/file-info/${encodeURIComponent(filename)}`);
        show('out-s3-file-info', await res.json());
      });

      // 15) Tạo signed URL để tải file từ S3
      document.getElementById('form-s3-download-url').addEventListener('submit', async e => {
        e.preventDefault();
        const filename = document.getElementById('s3DownloadFileName').value.trim();
        const expiresIn = document.getElementById('s3ExpiresIn').value;
        if (!filename) {
          show('out-s3-download-url', { success: false, message: 'Vui lòng nhập filename' });
          return;
        }
        const url = `${apiBase}/s3/download-url/${encodeURIComponent(filename)}${expiresIn ? `?expiresIn=${expiresIn}` : ''}`;
        const res = await fetch(url);
        const result = await res.json();
        show('out-s3-download-url', result);

        // Nếu có signed URL, hiển thị link để mở
        if (result.success && result.data.signedUrl) {
          const link = document.createElement('a');
          link.href = result.data.signedUrl;
          link.target = '_blank';
          link.textContent = 'Mở file trong tab mới';
          link.style.display = 'block';
          link.style.marginTop = '10px';
          link.style.color = '#007bff';
          document.getElementById('out-s3-download-url').parentNode.appendChild(link);
        }
      });

      // 16) Tải file trực tiếp từ S3
      document.getElementById('form-s3-download').addEventListener('submit', async e => {
        e.preventDefault();
        const filename = document.getElementById('s3DirectDownloadFileName').value.trim();
        if (!filename) {
          show('out-s3-download', { success: false, message: 'Vui lòng nhập filename' });
          return;
        }
        // Mở file download trong tab mới
        window.open(`${apiBase}/s3/download/${encodeURIComponent(filename)}`, '_blank');
        show('out-s3-download', { success: true, message: 'Đang tải file ở tab mới' });
      });

      // 17) Redirect đến file trong S3
      document.getElementById('form-s3-redirect').addEventListener('submit', async e => {
        e.preventDefault();
        const filename = document.getElementById('s3RedirectFileName').value.trim();
        const expiresIn = document.getElementById('s3RedirectExpiresIn').value;
        if (!filename) {
          show('out-s3-redirect', { success: false, message: 'Vui lòng nhập filename' });
          return;
        }
        const url = `${apiBase}/s3/redirect/${encodeURIComponent(filename)}${expiresIn ? `?expiresIn=${expiresIn}` : ''}`;
        // Redirect đến file
        window.location.href = url;
        show('out-s3-redirect', { success: true, message: 'Đang redirect đến file...' });
      });

      // 18) Lấy data viewImageFileName theo ItemNum
      document.getElementById('form-view-image-file-name').addEventListener('submit', async e => {
        e.preventDefault();
        const itemNum = document.getElementById('viewImageFileNameItemNum').value.trim();
        if (!itemNum) {
          show('out-view-image-file-name', { success: false, message: 'Vui lòng nhập ItemNum' });
          return;
        }
        const res = await fetch(`${apiBase}/view-image-file-name/${encodeURIComponent(itemNum)}`);
        show('out-view-image-file-name', await res.json());
      });

      // 19) Lấy tất cả data viewImageFileName
      document
        .getElementById('form-all-view-image-file-name')
        .addEventListener('submit', async e => {
          e.preventDefault();
          const res = await fetch(`${apiBase}/view-image-file-name`);
          show('out-all-view-image-file-name', await res.json());
        });

      // 20) Lấy cấu trúc viewImageFileName
      document
        .getElementById('form-view-image-file-name-structure')
        .addEventListener('submit', async e => {
          e.preventDefault();
          const res = await fetch(`${apiBase}/view-image-file-name/structure`);
          show('out-view-image-file-name-structure', await res.json());
        });
    </script>
  </body>
</html>
